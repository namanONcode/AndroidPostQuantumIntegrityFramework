# =============================================================================
# AnchorPQ Docker Compose Configuration
# Production-ready setup with PostgreSQL and AnchorPQ Server
# =============================================================================

services:
  # ===========================================================================
  # PostgreSQL Database
  # ===========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: anchorpq-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USERNAME:-anchorpq}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-anchorpq_secret}
      POSTGRES_DB: ${DB_NAME:-anchorpq}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Note: init-db.sql must have read permissions (chmod 644)
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:z
    ports:
      - "${DB_EXTERNAL_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-anchorpq} -d ${DB_NAME:-anchorpq}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - anchorpq-network

  # ===========================================================================
  # AnchorPQ Verification Server
  # ===========================================================================
  anchorpq-server:
    build:
      context: ./anchorpq-server
      dockerfile: Dockerfile
    image: anchorpq/anchorpq-server:latest
    container_name: anchorpq-server
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Database configuration
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-anchorpq}
      DB_USERNAME: ${DB_USERNAME:-anchorpq}
      DB_PASSWORD: ${DB_PASSWORD:-anchorpq_secret}

      # Quarkus configuration
      QUARKUS_HTTP_PORT: 8080
      QUARKUS_HTTP_HOST: 0.0.0.0

      # ML-KEM key persistence (optional)
      # MLKEM_KEY_PATH: /app/keys/mlkem-keypair.bin

      # Java options
      JAVA_OPTS: "-Xms256m -Xmx512m -XX:+UseG1GC"
    ports:
      - "${SERVER_PORT:-8080}:8080"
    volumes:
      # Optional: Persist ML-KEM keys across restarts
      - mlkem_keys:/app/keys
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - anchorpq-network

# =============================================================================
# Networks
# =============================================================================
networks:
  anchorpq-network:
    driver: bridge
    name: anchorpq-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  postgres_data:
    name: anchorpq-postgres-data
  mlkem_keys:
    name: anchorpq-mlkem-keys

