name: AnchorPQ E2E Integration

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  e2e-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    timeout-minutes: 45
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Set up Maven cache
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Grant execute permission for gradlew and scripts
        run: |
          chmod +x gradlew
          chmod +x anchorpq-demo-app/gradlew
          chmod +x scripts/*.sh

      - name: Run E2E Integration Script
        run: ./scripts/e2e-integration-test.sh
        env:
          MAVEN_PROJECTBASEDIR: ${{ github.workspace }}/anchorpq-server

      - name: Run Android Unit Tests
        run: ./gradlew -p anchorpq-demo-app :app:testDebugUnitTest

      - name: Start Server for Instrumental Tests
        run: |
          # Ensure containers are running (rebuild if needed)
          docker compose up -d --build postgres anchorpq-server
          
          # Wait for server availability with retries
          echo "Waiting for server to be ready..."
          timeout 120s bash -c 'until curl -sf http://localhost:8080/public-key > /dev/null 2>&1; do sleep 3; done' || {
            echo "Server start failed! Docker logs:"
            docker compose logs
            exit 1
          }
          
          # Seed Database (Required because E2E script cleans up volume)
          curl -sf --retry 3 --retry-delay 2 --retry-connrefused \
            -X POST "http://localhost:8080/admin/records" \
            -H "Content-Type: application/json" \
            -d '{
              "version": "1.0.0",
              "variant": "debug",
              "merkleRoot": "5dc5ef07216c2dd47920f9a8df688fa2a7dc340cc57704c1f69abf0cf821679a",
              "signerFingerprint": "0000000000000000000000000000000000000000000000000000000000000000",
              "description": "Demo app debug build - CI test"
            }'

      - name: Test Public Key Endpoint
        run: |
          RESPONSE=$(curl -sf --retry 5 --retry-delay 3 --retry-connrefused http://localhost:8080/public-key) || {
            echo "❌ Public key endpoint failed (curl error $?)"
            docker compose logs anchorpq-server
            exit 1
          }
          echo "Public key response: $RESPONSE"
          
          if echo "$RESPONSE" | grep -q "publicKey"; then
            echo "✅ Public key endpoint working"
          else
            echo "❌ Public key endpoint returned unexpected response"
            exit 1
          fi

      - name: Run Android Instrumental Tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          script: |
            adb kill-server
            adb start-server
            adb wait-for-device
            timeout 60s bash -c 'until adb shell pm list packages > /dev/null 2>&1; do echo "Waiting for package manager..."; sleep 2; done' || exit 1
            echo "Package manager is ready"
            ./gradlew -p anchorpq-demo-app :app:connectedCheck
          target: default
          arch: x86_64
          force-avd-creation: true
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          
      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            **/build/reports/tests/
            **/build/outputs/androidTest-results/
