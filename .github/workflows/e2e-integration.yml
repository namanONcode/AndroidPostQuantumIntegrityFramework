name: AnchorPQ E2E Integration
on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]
jobs:
  e2e-test:
    runs-on: macos-13 # Switches to macOS for native Hardware Acceleration
    timeout-minutes: 45
    permissions:
      contents: read
    steps:
      # ----------------------------
      # Checkout
      # ----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # ----------------------------
      # Java Setup (with Gradle cache)
      # ----------------------------
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle
          
      # ----------------------------
      # Docker Setup for macOS
      # ----------------------------
      - name: Start Docker (Colima)
        uses: abiosoft/colima-action@v1
        with:
          colima-args: '--cpu 2 --memory 4'
      
      # ----------------------------
      # Maven Cache
      # ----------------------------
      - name: Cache Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      
      # ----------------------------
      # Permissions
      # ----------------------------
      - name: Grant execute permissions
        run: |
          chmod +x gradlew
          chmod +x anchorpq-demo-app/gradlew
          chmod +x scripts/*.sh
      
      # ----------------------------
      # Backend E2E
      # ----------------------------
      - name: Run Backend E2E Integration
        run: ./scripts/e2e-integration-test.sh
        env:
          MAVEN_PROJECTBASEDIR: ${{ github.workspace }}/anchorpq-server
      
      # ----------------------------
      # Android Unit Tests
      # ----------------------------
      - name: Run Android Unit Tests
        run: ./gradlew -p anchorpq-demo-app :app:testDebugUnitTest
      
      # ----------------------------
      # Start Backend for Instrumentation
      # ----------------------------
      - name: Start Backend Server
        run: |
          docker compose up -d --build postgres anchorpq-server
          echo "Waiting for backend..."
          timeout 120s bash -c '
            until curl -sf http://localhost:8080/public-key > /dev/null 2>&1; do
              sleep 3
            done
          '
          echo "Seeding database..."
          curl -sf \
            -X POST "http://localhost:8080/admin/records" \
            -H "Content-Type: application/json" \
            -d '{
              "version": "1.0.0",
              "variant": "debug",
              "merkleRoot": "5dc5ef07216c2dd47920f9a8df688fa2a7dc340cc57704c1f69abf0cf821679a",
              "signerFingerprint": "0000000000000000000000000000000000000000000000000000000000000000",
              "description": "Demo app debug build - CI test"
            }'
            
      # ----------------------------
      # Instrumentation Tests
      # ----------------------------
      - name: Run Android Instrumentation Tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 33          # Bumped to a modern API level!
          target: google_apis
          arch: x86_64
          profile: Nexus 6
          force-avd-creation: true
          disable-animations: true
          # Removed the swiftshader fallback so it utilizes macOS hardware acceleration
          emulator-options: >
            -no-window
            -no-snapshot
            -noaudio
            -no-boot-anim
            -camera-back none
            -no-metrics
          script: |
            echo "Unlocking device..."
            adb shell input keyevent 82
            
            echo "Running instrumentation tests..."
            ./gradlew -p anchorpq-demo-app :app:connectedCheck --stacktrace
            
      # ----------------------------
      # Upload Test Reports
      # ----------------------------
      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            **/build/reports/tests/
            **/build/reports/androidTests/
            **/build/outputs/androidTest-results/
